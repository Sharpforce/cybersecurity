---
description: 'Dernière mise à jour : 22/06/2022'
---

# CVE-2022-32442

## Description

* **Vendeur :** Yuba ([https://yuba.ch/](https://yuba.ch/))
* **Produit :** u5CMS ([https://yuba.ch/index.php?c=u5cms\&l=en](https://yuba.ch/index.php?c=u5cms\&l=en))
* **Version(s) impactée(s) :** 8.3.5
* **Type de vulnérabilité :** XSS réfléchie (CWE-79 - [https://cwe.mitre.org/data/definitions/79.html](https://cwe.mitre.org/data/definitions/79.html))

La page d'accueil d'u5CMS en version 8.3.5 est vulnérable à une Cross-Site Scripting (XSS) de type réfléchie. La charge peut être être injectée après le caractère `?` de l'URL et est réfléchie dans les deux liens HTML permettant le changement de langue.

![Le score CVSS n'est pas encore disponible (https://nvd.nist.gov/vuln/detail/CVE-2022-32442)](<../../.gitbook/assets/image (4).png>)

## Analyse de la vulnérabilité

Ce qui suit le caractère `?` de l'URL est réfléchie dans l'attribut `href` du lien `<a></a>` des deux (autres) choix de langues qu'offre le CMS :&#x20;

![Point d'injection de la XSS réfléchie](<../../.gitbook/assets/image (9).png>)

L'injection d'un caractère `"` visant à sortir de l'attribut `href` afin d'injecter la charge malicieuse `"onmouseover='alert(1)'value="&l=fr` ne fonctionne pas. En effet, le navigateur encode les caractères spéciaux rendant l'attaque ainsi sans effet :&#x20;

![Le navigateur (ici Firefox) encode les caractères spéciaux](<../../.gitbook/assets/image (8).png>)

L'encodage effectué par les navigateurs est le résultat de la bonne implémentation de la section 2.2 de la RFC 1738 ([https://datatracker.ietf.org/doc/html/rfc1738#section-2.2](https://datatracker.ietf.org/doc/html/rfc1738#section-2.2)) :&#x20;

![RFC 1738 - Section 2.2](<../../.gitbook/assets/image (7).png>)

Firefox, Chrome ou encore Edge sont des bons élèves et implémentent correctement cette RFC, mais ce n'est pas forcément le cas pour ce bon vieux IE11. En effet ce navigateur n'encode pas les noms et les valeurs des paramètres :&#x20;

![IE11 n'implémente pas complètement l'encodage des caractères indiqué dans la RFC 1738](<../../.gitbook/assets/image (5).png>)



Malheureusement l'exécution de scripts plus complexes n'est pas possible à cause de son filtre XSS (mais il existe des méthodes de contournement de ce filtre sur le net, le plus difficile reste de savoir si elles fonctionnent). A ces difficultés d'exploitation, s'ajoute l'annonce de Microsoft que Internet Explorer 11 ne sera plus supporté et progressivement retiré des versions de Windows.

Afin de prouver la présence de la XSS réfléchie sur n'importe quel navigateur il est possible de passer par une interception de proxy via Burp (ou autre) :&#x20;

![Exécution de la XSS réfléchie sur Firefox en passant par une interception avec Burp](<../../.gitbook/assets/image (11).png>)

## Code vulnérable

Le fichier `index.php` va rechercher les motifs `{{{motifs}}}` dans le fichier `htmltemplate.css` :

{% code title="index.php" %}
```php
$template=str_replace('[_logo_]','r/logo/'.def($file_d,$file_e,$file_f).'?t='.filemtime('r/logo/'.def($file_d,$file_e,$file_f)),file_get_contents('r/htmltemplate.css'));
...
$i_i_item=explode('{{{',$template);
for ($i_i_i=0;$i_i_i<count($i_i_item);$i_i_i++) {
   if (strpos($i_i_item[$i_i_i],'}}}')>1) {
      $i_i_part=explode('}}}',$i_i_item[$i_i_i]);
```
{% endcode %}

A un certain moment, le motif sera celui concernant l'affiche des liens de changement de langues `{{{languages}}}` :&#x20;

{% code title="htmltemplate.css" %}
```html
<div id="main">
  <div id="header" style="background:url([_logo_]);background-size:cover">
    <div id="metanavi">&nbsp;&nbsp;&nbsp;<a name="search"></a>{{{search}}}
      <div id="languages">{{{languages}}}</div>
```
{% endcode %}

Alors, le fichier nommé `u5sys.languages.php` sera inclus (`$i_i_part[0]` vaut dans ce cas  `"languages"`) :&#x20;

{% code title="index.php" %}
```php
if (file_exists('u5sys.'.$i_i_part[0].'.php')) include('u5sys.'.$i_i_part[0].'.php');
```
{% endcode %}

Ce nouveau fichier va afficher au sein de la page d'accueil les deux liens de changement de langues suivant la valeur contenu dans le paramètre de l'URL `"l"` :

{% code title="u5sys.languages.php" %}
```php
if ($_GET['l']==$lan3na) {
  $lancode=$lan3na;
  $nbsp='';
  if ($lan1name!='' && $lan2name!='') $nbsp='&nbsp;&nbsp;&nbsp;';
  if($u5showlinkofactivelanguageinmetanavi=='yes')$lanswitch='<a href="'.chglang($lan1na).'">'.$lan1name.'</a>'.$nbsp.'<a href="'.chglang($lan2na).'">'.$lan2name.'</a>'.$nbsp.'<a href="'.chglang($lan3na).'">'.$lan3name.'</a>';
  else $lanswitch='<a href="'. chglang($lan1na).'">'.$lan1name.'</a>'.$nbsp.'<a href="'.chglang($lan2na).'">'.$lan2name.'</a>';
}

...

echo $lanswitch;
```
{% endcode %}

{% hint style="info" %}
Il existe en fait trois blocs du même genre en fonction de la langue sélectionnée : "fr", "de" ou "en". L'exemple de code ici correspond à la langue "fr" (voir explication ci-dessous).
{% endhint %}

La fonction `chglang()` retourne la variable `$u` qui prend comme valeur le caractère `?` ainsi que  ce qui suit dans l'URL (grâce à `$_SERVER['QUERY_STRING']`) :

{% code title="chglang.inc.php" %}
```php
function chglang($l) {
  global $lan1na;
  global $lan2na;
  global $lan3na;
  
  $u='?'.$_SERVER['QUERY_STRING'];
  //echo 'query string : ' . $_SERVER['QUERY_STRING'];
  $u=str_replace('l='.$lan1na,'',$u);
  $u=str_replace('l='.$lan2na,'',$u);
  $u=str_replace('l='.$lan3na,'',$u);
  $u=str_replace('l=','',$u);
  $u=($u.'&l='.$l);
  $u=str_replace('&&','&',$u);
  $u=str_replace('?&','?',$u);
  //$u=str_replace('&','&amp;',$u);
  return $u;
}
```
{% endcode %}

{% hint style="info" %}
Les variables $lan1na, $lan2na, $lan3na correspondent respectivement aux chaines "de", "en" et "fr". Elles sont récupérées depuis la table `languages` en base de données.
{% endhint %}

{% code title="globals.inc.php" %}
```php
$sql_a="SELECT * FROM languages";
$result_a=mysql_query($sql_a);
...
$row_a = mysql_fetch_array($result_a);
...
$lan1na=$row_a['lan1na'];
$lan2na=$row_a['lan2na'];
$lan3na=$row_a['lan3na'];
```
{% endcode %}

![Les langues disponibles sont récupérées depuis la base de données](<../../.gitbook/assets/image (3).png>)

## Proposition de correction

La proposition de correction ici est d'encoder, grâce à la méthode `htmlspecialchars()`, le retour de la fonction `chlang()` lors de sa concaténation :

{% code title="u5sys.languages.php" %}
```php
require_once('chglang.inc.php'); 
require_once('globals.inc.php');

if ($_GET['l']==$lan3na) {
  $lancode=$lan3na;
  $nbsp='';
  if ($lan1name!='' && $lan2name!='') $nbsp='&nbsp;&nbsp;&nbsp;';
  if($u5showlinkofactivelanguageinmetanavi=='yes')$lanswitch='<a href="'.htmlspecialchars(chglang($lan1na)).'">'.$lan1name.'</a>'.$nbsp.'<a href="'.htmlspecialchars(chglang($lan2na)).'">'.$lan2name.'</a>'.$nbsp.'<a href="'.htmlspecialchars(chglang($lan3na)).'">'.$lan3name.'</a>';
  else $lanswitch='<a href="'. htmlspecialchars(chglang($lan1na)).'">'.$lan1name.'</a>'.$nbsp.'<a href="'.htmlspecialchars(chglang($lan2na)).'">'.$lan2name.'</a>';
}

else if ($_GET['l']==$lan2na) {
  $lancode=$lan2na;
  $lancode=$lan3na;
  $nbsp='';
  if ($lan1name!='' && $lan3name!='') $nbsp='&nbsp;&nbsp;&nbsp;';
  if($u5showlinkofactivelanguageinmetanavi=='yes')$lanswitch='<a href="'.htmlspecialchars(chglang($lan1na)).'">'.$lan1name.'</a>'.$nbsp.'<a href="'.htmlspecialchars(chglang($lan2na)).'">'.$lan2name.'</a>'.$nbsp.'<a href="'.htmlspecialchars(chglang($lan3na)).'">'.$lan3name.'</a>';
  else $lanswitch='<a href="'.htmlspecialchars(chglang($lan1na)).'">'.$lan1name.'</a>'.$nbsp.'<a href="'.htmlspecialchars(chglang($lan3na)).'">'.$lan3name.'</a>';
}

else {
  $lancode=$lan1na;
  $lancode=$lan3na;
  $nbsp='';
  if ($lan3name!='' && $lan2name!='') $nbsp='&nbsp;&nbsp;&nbsp;';
  if($u5showlinkofactivelanguageinmetanavi=='yes')$lanswitch='<a href="'.htmlspecialchars(chglang($lan1na)).'">'.$lan1name.'</a>'.$nbsp.'<a href="'.htmlspecialchars(chglang($lan2na)).'">'.$lan2name.'</a>'.$nbsp.'<a href="'.htmlspecialchars(chglang($lan3na)).'">'.$lan3name.'</a>';
  else $lanswitch='<a href="'.htmlspecialchars(chglang($lan3na)).'">'.$lan3name.'</a>'.$nbsp.'<a href="'.htmlspecialchars(chglang($lan2na)).'">'.$lan2name.'</a>';
}

if ($_GET['p']=='2') $lanswitch='';
echo $lanswitch;
```
{% endcode %}

{% hint style="info" %}
Je n'ai pas chercher quand est ce que la variable `$u5showlinkofactivelanguageinmetanavi` pouvais se retrouver à `"yes"`, mais si cela peut être le cas alors l'affichage doit également être protégée.
{% endhint %}

## Ressources

* [https://github.com/u5cms/u5cms/issues/49](https://github.com/u5cms/u5cms/issues/49)
