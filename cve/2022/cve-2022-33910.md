---
description: 'Dernière mise à jour : 07/07/2022'
---

# CVE-2022-33910

## Description

* **Vendeur :** MantisBT ([https://www.mantisbt.org/](https://www.mantisbt.org/))
* **Produit :** MantisBT ([https://www.mantisbt.org/download.php](https://www.mantisbt.org/download.php))
* **Version(s) impactée(s) :** < 2.25.5
* **Type de vulnérabilité :** XSS stockée ([CWE-79 - Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')](https://cwe.mitre.org/data/definitions/79.html))

Les versions <2.25.5 de Mantis Bug Tracker sont vulnérables à une faille de Cross-Site Scripting via l'upload d'un fichier au format SVG en tant que pièce jointe d'un rapport ou d'une note d'anomalie.

![Score CVSS (https://nvd.nist.gov/vuln/detail/CVE-2022-33910)](<../../.gitbook/assets/image (14) (1).png>)

## Analyse de la vulnérabilité

Il est possible d'attacher le fichier SVG créé pour l'occasion en déclarant une nouvelle anomalie :&#x20;

![Déclaration d'une nouvelle anomalie](<../../.gitbook/assets/image (9) (1).png>)

ou également dans une note/commentaire d'une anomalie :&#x20;

![Ajout d'une note à une anomalie](<../../.gitbook/assets/image (10).png>)

Une fois le fichier malveillant ainsi uploadé, il faudra que la victime visualise le fichier SVG, qui s'ouvrira alors dans un nouvel onglet, provoquant ainsi l'exécution du code malicieux (ou presque) :

![Affichage du fichier SVG à l'ouverture de la pièce jointe](<../../.gitbook/assets/image (15) (1).png>)

En effet, un problème de CSP vient empêcher l'exécution du script `inline` :&#x20;

![CSP interdit l'exécution du script inline présent dans le fichier SVG](<../../.gitbook/assets/image (14) (2).png>)

A noter que l'attaque ne peut être réalisée à la visualisation de l'anomalie car le fichier SVG est affiché via une balise `<img />` :&#x20;

![Lors de la visualisation de l'anomalie le fichier SVG est affiché via une balise \<img /> ](<../../.gitbook/assets/image (8).png>)

## Code vulnérable

Par défaut, tous les types de fichiers peuvent être uploadés :&#x20;

{% code title="config_default_inc.php" %}
```php
/**
 * Files that are allowed or not allowed.  Separate items by commas.
 * eg. 'php,html,java,exe,pl'
 * if $g_allowed_files is filled in NO other file types will be allowed.
 * $g_disallowed_files takes precedence over $g_allowed_files
 * @global string $g_allowed_files
 */
$g_allowed_files = '';

/**
 *
 * @global string $g_disallowed_files
 */
$g_disallowed_files = '';
```
{% endcode %}

Les fichiers ainsi présents en tant que pièces jointes sont soit, consultés directement dans le navigateur (pour les formats `jpeg`, `gif`, `tiff`, `bmp`, `svg+xml`, `png` et `pdf`), soit téléchargés :&#x20;

{% code title="file_download.php" %}
```php
$t_show_inline = $f_show_inline;
$t_mime_force_inline = array( 'image/jpeg', 'image/gif', 'image/tiff', 'image/bmp', 'image/svg+xml', 'image/png', 'application/pdf' );
```
{% endcode %}

A priori donc, rien n'interdit d'uploader un fichier SVG malveillant et aucun traitement d'assainissement ne semble être effectué :&#x20;

{% code title="malicious.svg" %}
```svg
<?xml version="1.0" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">

<svg version="1.1" baseProfile="full" xmlns="http://www.w3.org/2000/svg">
   <rect width="300" height="100" style="fill:rgb(0,0,255);stroke-width:3;stroke:rgb(0,0,0)" />
     <script type="text/javascript">
    alert(document.domain)
  </script>
</svg>
```
{% endcode %}

En temps normal, la visualisation du fichier SVG devrait provoquer l'exécution du code Javascript mais c'est sans compter sur la configuration par défaut de MantisBT. La configuration propose un ensemble de directives CSP, dont celle concernant l'exécution de Javascript, ne permettant l'exécution de fichiers Javascript provenant seulement du même domaine (`self`) :&#x20;

```http
HTTP/1.1 200 OK
X-Frame-Options: DENY
Content-Security-Policy: default-src 'self'; frame-ancestors 'none'; style-src 'self' 'unsafe-inline'; script-src 'self'; img-src 'self' 'self' data:
Content-Disposition: filename*=UTF-8''xss.svg; filename="xss.svg"
X-Content-Type-Options: nosniff
CContent-Type: image/svg+xml; charset=us-ascii

<?xml version="1.0" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">

<svg version="1.1" baseProfile="full" xmlns="http://www.w3.org/2000/svg">
   <rect width="300" height="100" style="fill:rgb(0,0,255);stroke-width:3;stroke:rgb(0,0,0)" />
     <script type="text/javascript">
    alert(document.cookie)
  </script>
</svg>
```

Cette configuration est appliquée par la méthode `http_security_headers()` présente dans le fichier `core/http_api.php` :&#x20;

{% code title="http_api.php" %}
```php
# Define Content Security Policy
http_csp_add( 'default-src', "'self'" );
http_csp_add( 'frame-ancestors', "'none'" );
http_csp_add( 'style-src', "'self'" );
http_csp_add( 'style-src', "'unsafe-inline'" );
http_csp_add( 'script-src', "'self'" );
http_csp_add( 'img-src', "'self'" );
http_csp_add( 'img-src', "'self' data:" );
```
{% endcode %}

Pour exploiter cette vulnérabilité il faudra donc ici espérer un relâchement de la configuration de MantisBT de la part de l'administrateur en charge du site, ou alors, identifier un moyen d'uploader un fichier javascript sur le serveur puis de l'exécuter via le fichier SVG.

## Correction

La vulnérabilité a été corrigée dans la version 2.25.5 de MantisBT. Tout d'abord, la configuration par défaut évolue et interdit maintenant l'upload de fichier au format SVG :&#x20;

{% code title="config_defaults_inc.php" %}
```php
/**
 * Forbidden file types (blacklist).
 *
 * All file extensions in this list will be unauthorized.
 * Separate items by commas, e.g. 'php,html,java,exe,pl,svg'.
 *
 * SVG files are disabled by default, for security reasons. It is recommended to
 * also disable all extensions that can be executed by your server;
 *
 * @see $g_allowed_files
 * @global string $g_disallowed_files
 */
$g_disallowed_files = 'svg';
```
{% endcode %}

Dans un second temps, lorsqu'un utilisateur va ouvrir une pièce jointe de type SVG (dans le cas ou l'administrateur aura modifié la configuration par défaut), le fichier ne sera plus visualisé dans le navigateur mais un téléchargement forcé sera effectué :&#x20;

{% code title="file_download.php" %}
```php
$t_mime_force_attachment = array(
  'application/x-shockwave-flash',
  'image/svg+xml', # SVG could contain CSS or scripting, see #30384
  'text/html',
);
```
{% endcode %}

## Ressources

* [https://github.com/mantisbt/mantisbt/commits/release-2.25.5](https://github.com/mantisbt/mantisbt/commits/release-2.25.5)
* [https://mantisbt.org/bugs/view.php?id=29135](https://mantisbt.org/bugs/view.php?id=29135)
